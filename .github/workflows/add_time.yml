name: è‡ªåŠ¨å¢åŠ æœåŠ¡å™¨æ—¶é—´

on:
  workflow_dispatch: # å…è®¸åœ¨ Actions é¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ,æ–¹ä¾¿æµ‹è¯•
  schedule:
    - cron: '30 0 */2 * *'

jobs:
  add_time:
    runs-on: ubuntu-latest # åœ¨æœ€æ–°çš„ Ubuntu ç¯å¢ƒä¸Šè¿è¡Œ

    # æˆäºˆå·¥ä½œæµå†™å…¥ä»“åº“å†…å®¹çš„æƒé™
    permissions:
      contents: write

    steps:
      - name: Install Google Chrome
        run: |
          sudo apt-get update
          # æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…å¿…è¦è½¯ä»¶
          sudo apt update
          sudo apt install -y \
              tigervnc-standalone-server \
              openbox \
              websockify \
              novnc \
              git \
              wget \
              fonts-dejavu-core \
              net-tools
          wget -O google-chrome-stable_current_amd64.deb https://dl.google.com/linux/chrome/deb/pool/main/g/google-chrome-stable/google-chrome-stable_143.0.7499.169-1_amd64.deb
          sudo apt install -y --allow-downgrades ./google-chrome-stable_current_amd64.deb
          sudo apt install -y language-pack-zh-hans fonts-wqy-zenhei fonts-wqy-microhei
          echo "Checking Chrome installation..." 
          which google-chrome
          google-chrome --version

      - name: Checkout repository 
        uses: actions/checkout@v4

      - name: Set up Python 
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 

      - name: Install requirements.txt
        run: |
          pip install -r requirements.txt

      - name: Export all secrets to env vars
        uses: oNaiPs/secrets-to-env-action@v1
        with:
          secrets: ${{ toJSON(secrets) }}

      - name: Start noVNC 
        run: |
          sudo bash runnovnc.sh
      - name: Wait for noVNC
        run: |
          for i in {1..60}; do
            if nc -z localhost 8080; then
              echo "noVNC å·²å¯åŠ¨"
              break
            fi
            echo "ç­‰å¾…ä¸­ ($i)..."
            sleep 1
          done

      - name: Run Time Adder Script 
        id: run_script
        run: |
          mkdir -p "$GITHUB_WORKSPACE/.tmp"
          export TMPDIR="$GITHUB_WORKSPACE/.tmp"
          echo "Using TMPDIR=$TMPDIR"
          export DISPLAY=:1
          echo "Using DISPLAY=$DISPLAY"
          python main.py

      - name: Upload error artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: screenshots

      # Telegram é€šçŸ¥ - å·¥ä½œæµå¤±è´¥æ—¶
      - name: Send Telegram Notification on Failure
        if: failure()
        run: |
          if [ -n "${{ secrets.TG_BOT_TOKEN }}" ] && [ -n "${{ secrets.TG_CHAT_ID }}" ]; then
            MESSAGE="ğŸ”´ <b>GitHub Actions å·¥ä½œæµå¤±è´¥</b>%0A%0A"
            MESSAGE="${MESSAGE}ğŸ“¦ ä»“åº“: ${{ github.repository }}%0A"
            MESSAGE="${MESSAGE}ğŸ”§ å·¥ä½œæµ: ${{ github.workflow }}%0A"
            MESSAGE="${MESSAGE}ğŸ”— è¿è¡Œ: ${{ github.run_number }}%0A"
            MESSAGE="${MESSAGE}ğŸ‘¤ è§¦å‘è€…: ${{ github.actor }}%0A"
            MESSAGE="${MESSAGE}ğŸ”— æŸ¥çœ‹è¯¦æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TG_CHAT_ID }}" \
              -d parse_mode=HTML \
              -d text="$MESSAGE"
          else
            echo "âš ï¸ æœªé…ç½® Telegram é€šçŸ¥(ç¼ºå°‘ TG_BOT_TOKEN æˆ– TG_CHAT_ID)"
          fi

      # Telegram é€šçŸ¥ - å·¥ä½œæµæˆåŠŸæ—¶(å¯é€‰,å¦‚æœä¸éœ€è¦å¯ä»¥æ³¨é‡Šæ‰)
      - name: Send Telegram Notification on Success
        if: success()
        run: |
          if [ -n "${{ secrets.TG_BOT_TOKEN }}" ] && [ -n "${{ secrets.TG_CHAT_ID }}" ]; then
            MESSAGE="âœ… <b>GitHub Actions å·¥ä½œæµæˆåŠŸ</b>%0A%0A"
            MESSAGE="${MESSAGE}ğŸ“¦ ä»“åº“: ${{ github.repository }}%0A"
            MESSAGE="${MESSAGE}ğŸ”§ å·¥ä½œæµ: ${{ github.workflow }}%0A"
            MESSAGE="${MESSAGE}ğŸ”— è¿è¡Œ: ${{ github.run_number }}"
            
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TG_CHAT_ID }}" \
              -d parse_mode=HTML \
              -d text="$MESSAGE"
          else
            echo "âš ï¸ æœªé…ç½® Telegram é€šçŸ¥(ç¼ºå°‘ TG_BOT_TOKEN æˆ– TG_CHAT_ID)"
          fi

      # - name: Commit time.txt to repo
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   run: |
      #     git config user.name "github-actions[bot]"
      #     git config user.email "github-actions[bot]@users.noreply.github.com"

      #     # å¦‚æœ time.txt ä¸å­˜åœ¨,è¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œ
      #     if [ ! -f time.txt ]; then
      #       echo "é¦–æ¬¡ç”Ÿæˆæ—¶é—´:$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
      #     else
      #       echo "$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
      #     fi

      #     git add time.txt

      #     # å¦‚æœæœ‰æ›´æ”¹å†æäº¤
      #     if git diff --cached --quiet; then
      #       echo "æ— å˜åŒ–,æ— éœ€æäº¤"
      #     else
      #       git commit -m "ğŸ• æ›´æ–°æ—¶é—´æ–‡ä»¶: $(date +'%Y-%m-%d %H:%M:%S')"
      #       git push origin HEAD:main
      #     fi
